{"componentChunkName":"component---src-templates-post-template-jsx","path":"/posts/ClusterAPI-Setup-Steps--vSphere-","result":{"data":{"site":{"siteMetadata":{"title":"Blog by Sam Perrin","subtitle":"Automation Consultant, currently working at Xtravirt. Interested in all things automation/devops related.","copyright":"© All rights reserved.","author":{"name":"Sam Perrin","twitter":"sam_perrin"},"disqusShortname":"","url":"https://samperrin.netlify.com"}},"markdownRemark":{"id":"b475f106-81a7-51b0-afda-9d424a920621","html":"<p>Download the PhotonOS Kubernetes and HAProxy images from here <a href=\"http://storage.googleapis.com/capv-images\">http://storage.googleapis.com/capv-images</a></p>\n<p><strong>HAProxy</strong> version used in the steps below: <a href=\"http://storage.googleapis.com/capv-images/extra/haproxy/release/v0.6.4/capv-haproxy-v0.6.4.ova\">http://storage.googleapis.com/capv-images/extra/haproxy/release/v0.6.4/capv-haproxy-v0.6.4.ova</a></p>\n<p><strong>PhotonOS Kubernetes</strong> version used in the steps below: <a href=\"http://storage.googleapis.com/capv-images/release/v1.18.2/photon-3-kube-v1.18.2.ova\">http://storage.googleapis.com/capv-images/release/v1.18.2/photon-3-kube-v1.18.2.ova</a></p>\n<p>Deploy both OVA files in to vSphere, take a snapshot of them, and then covert to templates.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/854e2ea588f09e1ae24749541ef37d90/a1a85/templates.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 242px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 41.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABMUlEQVQoz32R226DMBBE8///1pe+tWoBYwgEI9uArxAyXTtNpKZRRlrZMnj27PhwuVyw72cszkMuFvOywFqLEHxejbFY1xXpv1RJt/WZDumjdw6DmsAGCaEUmpqD1RXKskRRFOgHcb/wyuxumLTvO6wPEJOBCxGOmsQ1whNpjBHjKOC9v5s+qz+GIQQa0eGzGdAJCUkGnHNUjGWzuma5ySslr8PjGGmvjcdIpNu25UYpw0jUgQiTaTpLNc8zZWxy/SPMj/O7b0eN96LB6dThizKctEJVMcq0wrFt0HUdFGXdn3qiHyGlvOFcDR9fTxsHoRcicjk3nykjjDVE5uCsz4TbtmKaFBZznSYTPmaQxIXC20eFlnJLObK6xkA0QgxEyFF+V/lcaY2+42iPHTUO+e4PRA9r/Otm9KMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"templates\"\n        title=\"\"\n        src=\"/static/854e2ea588f09e1ae24749541ef37d90/a1a85/templates.png\"\n        srcset=\"/static/854e2ea588f09e1ae24749541ef37d90/8ff5a/templates.png 240w,\n/static/854e2ea588f09e1ae24749541ef37d90/a1a85/templates.png 242w\"\n        sizes=\"(max-width: 242px) 100vw, 242px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Create a new CentOS or Ubuntu VM to act as a temporary bootstrap server - steps below will be focused on CentOS. Alternatively, install the components below on your current device.</p>\n<p>This machine will be used in later stages of your cluster lifecycle management, due to the presence of <code class=\"language-text\">clusterctl</code></p>\n<p>Install Docker</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">curl</span> -fsSL https://get.docker.com -o get-docker.sh\n<span class=\"token function\">sudo</span> <span class=\"token function\">sh</span> get-docker.sh\n<span class=\"token assign-left variable\">MAINUSER</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">logname</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">usermod</span> -aG docker <span class=\"token variable\">$MAINUSER</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Install KIND</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token assign-left variable\">KINDVERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://github.com/kubernetes-sigs/kind/releases/latest/download <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -Po <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token variable\">)</span></span>\n<span class=\"token function\">curl</span> -L <span class=\"token string\">\"https://github.com/kubernetes-sigs/kind/releases/download/v<span class=\"token variable\">$KINDVERSION</span>/kind-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> -s <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token string\">'[:upper:]'</span> <span class=\"token string\">'[:lower:]'</span><span class=\"token variable\">)</span></span>-<span class=\"token variable\"><span class=\"token variable\">$(</span>dpkg --print-architecture<span class=\"token variable\">)</span></span>\"</span> -o /usr/local/bin/kind\n<span class=\"token function\">chmod</span> +x /usr/local/bin/kind</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Install kubectl </p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">curl</span> -LO <span class=\"token string\">\"https://storage.googleapis.com/kubernetes-release/release/<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://storage.googleapis.com/kubernetes-release/release/stable.txt<span class=\"token variable\">)</span></span>/bin/linux/amd64/kubectl\"</span>\n<span class=\"token function\">chmod</span> +x ./kubectl\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> ./kubectl /usr/local/bin/kubectl</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Install clusterctl</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token assign-left variable\">CLUSTERCTLVERSION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://github.com/kubernetes-sigs/cluster-api/releases/latest/download <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -Po <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token punctuation\">\\</span>.<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-9<span class=\"token punctuation\">]</span>+<span class=\"token variable\">)</span></span>\n<span class=\"token function\">curl</span> -L <span class=\"token string\">\"https://github.com/kubernetes-sigs/cluster-api/releases/download/v<span class=\"token variable\">$CLUSTERCTLVERSION</span>/clusterctl-<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">uname</span> -s <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token string\">'[:upper:]'</span> <span class=\"token string\">'[:lower:]'</span><span class=\"token variable\">)</span></span>-<span class=\"token variable\"><span class=\"token variable\">$(</span>dpkg --print-architecture<span class=\"token variable\">)</span></span>\"</span> -o /usr/local/bin/clusterctl\n<span class=\"token function\">chmod</span> +x /usr/local/bin/clusterctl</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Create KIND cluster</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">kind create cluster</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Create clusterctl.yaml to store configuration values. Replace the values where required. Take particular note of values between &#x3C; and >.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">mkdir</span> -p ~/.cluster-api\n<span class=\"token function\">tee</span> ~/.cluster-api/clusterctl.yaml <span class=\"token operator\">></span>/dev/null <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF\n## -- Controller settings -- ##\nVSPHERE_USERNAME: \"administrator@vsphere.local\"            # The username used to access the remote vSphere endpoint\nVSPHERE_PASSWORD: \"vmware1\"                                # The password used to access the remote vSphere endpoint\n\n## -- Required workload cluster default settings -- ##\nVSPHERE_SERVER: \"vcenter1.domain.com\"                                 # The vCenter server IP or FQDN\nVSPHERE_DATACENTER: \"Datacenter\"                                      # The vSphere datacenter to deploy the management cluster on\nVSPHERE_DATASTORE: \"Datastore\"                                        # The vSphere datastore to deploy the management cluster on\nVSPHERE_NETWORK: \"VM Network\"                                         # The VM network to deploy the management cluster on\nVSPHERE_RESOURCE_POOL: \"&lt;ClusterName>/Resources/&lt;ResourcePoolName>\"   # The vSphere resource pool for your VMs\nVSPHERE_FOLDER: \"vm/&lt;FolderName>/&lt;ChildFolderName>\"                   # The VM folder for your VMs. Set to \"\" to use the root vSphere folder\nVSPHERE_TEMPLATE: \"photon-3-kube-v1.18.2\"                             # The VM template to use for your management cluster.\nVSPHERE_HAPROXY_TEMPLATE: \"capv-haproxy-v0.6.4\"                       # The VM template to use for the HAProxy load balancer\nVSPHERE_SSH_AUTHORIZED_KEY: \"&lt;ssh key>\"                               # The public ssh authorized key on all machines in this cluster. Set to \"\" if you don't want to enable SSH, or are using another solution.\nEOF</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Initialise and Create the Bootstrap Management Cluster. Change the number of control-plane and worker nodes, kubernetes version etc as appropriate.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">clusterctl init --infrastructure vsphere\n<span class=\"token comment\"># if this fails use clusterctl init --infrastructure=vsphere:v0.6.6</span>\n<span class=\"token function\">mkdir</span> -p ~/local-control-plane\nclusterctl config cluster local-control-plane --infrastructure vsphere --kubernetes-version v1.18.2 --control-plane-machine-count <span class=\"token number\">1</span> --worker-machine-count <span class=\"token number\">1</span> <span class=\"token operator\">></span> ~/local-control-plane/cluster.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Review the cluster config file and make any required changes. Some suggestions to review are CPU, Memory, Storage and Pods CIDR range.</p>\n<p>You can use <code class=\"language-text\">sed</code> to do a find and replace within the file, the below examples are for changing the Storage and Memory on all virtual machines as part of this deployment and the Pods CIDR.</p>\n<ul>\n<li>Pod CIDR from <code class=\"language-text\">192.168.0.0/16</code> to <code class=\"language-text\">192.168.100.0/24</code></li>\n<li>Memory from <code class=\"language-text\">8192</code> to <code class=\"language-text\">4096</code></li>\n<li>Storage from <code class=\"language-text\">25</code> to <code class=\"language-text\">20</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/192.168.0.0\\/16/192.168.100.0\\/24/g\"</span> ~/local-control-plane/cluster.yaml\n<span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/memoryMiB: 8192/memoryMiB: 4096/g\"</span> ~/local-control-plane/cluster.yaml\n<span class=\"token function\">sed</span> -i <span class=\"token string\">\"s/diskGiB: 25/diskGiB: 20/g\"</span> ~/local-control-plane/cluster.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Deploy the cluster components. Monitor the deployment of virtual machines within vSphere.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">kubectl apply -f ~/local-control-plane/cluster.yaml</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Use <code class=\"language-text\">kubectl</code> to see cluster progress. The control planes won’t be Ready until we install a CNI in a later step.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">kubectl get cluster --all-namespaces\nkubectl get kubeadmcontrolplane --all-namespaces</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Retrieve the kubeconfig file for the local-control-plane cluster, and set it as KUBECONFIG environment variable.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">kubectl get secret local-control-plane-kubeconfig -o<span class=\"token operator\">=</span>jsonpath<span class=\"token operator\">=</span><span class=\"token string\">'{.data.value}'</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">{</span> base64 -d <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null <span class=\"token operator\">||</span> base64 -D<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">></span> ~/local-control-plane/kubeconfig\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">\"~/local-control-plane/kubeconfig\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span></span></pre></div>\n<p>Deploy Calico CNI to local-control-plane.</p>\n<p>Because we have set KUBECONFIG in the above step our kubectl commands will run against the local-control-plane cluster. If you want to be certain, add <code class=\"language-text\">--kubeconfig=&quot;~/local-control-plane/kubeconfig&quot;</code> to the commands. </p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml\n<span class=\"token comment\">#Example with kubeconfig specified</span>\n<span class=\"token comment\">#kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml --kubeconfig=\"~/local-control-plane/kubeconfig\"</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Now we will initialise the local-control-plane cluster as our cluster-api management cluster.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\">clusterctl init --infrastructure vsphere</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Revert back to the kubeconfig for the bootstrap cluster, migrate management components from it to the local-control-plane cluster, and finally delete.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token builtin class-name\">unset</span> KUBECONFIG\nclusterctl move --to-kubeconfig<span class=\"token operator\">=</span><span class=\"token string\">\"~/local-control-plane/kubeconfig\"</span>\nkind delete cluster --name bootstrap</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Set the local-control-plane kubeconfig as our default </p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token function\">cp</span> ~/local-control-plane/kubeconfig ~/.kube/config</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>You will now be able to perform cluster management operations. Some examples below.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre style=\"counter-reset: linenumber 0\" class=\"language-shell line-numbers\"><code class=\"language-shell\"><span class=\"token comment\">#Retrieve related vSphere VMs</span>\nkubectl get vspheremachine\n<span class=\"token comment\">#Retrieve related machines</span>\nkubectl get machine\n<span class=\"token comment\">#Retrieve additional machine details</span>\nkubectl describe machine <span class=\"token operator\">&lt;</span>machine-name<span class=\"token operator\">></span>\n<span class=\"token comment\">#Retrieve additional cluster information</span>\nkubectl describe cluster local-control-plane</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The next article will cover deploying a workload cluster that can be consumed by your development teams. </p>\n<p><strong>Next Article in this Series</strong>: <a href=\"ClusterAPI-Workload-Cluster--vSphere-\">ClusterAPI Workload Cluster (vSphere)</a></p>\n<p><strong>Reference</strong>: <a href=\"https://cluster-api.sigs.k8s.io/introduction.html\">The Cluster API project</a></p>","fields":{"tagSlugs":["/tags/development/","/tags/kubernetes/","/tags/vmware/"],"slug":"/posts/ClusterAPI-Setup-Steps--vSphere-"},"frontmatter":{"title":"ClusterAPI Setup Steps (vSphere)","tags":["development","kubernetes","vmware"],"date":"2020-08-02T20:56:17.019Z","description":"Steps to get a cluster-api management cluster up and running "}}},"pageContext":{"slug":"/posts/ClusterAPI-Setup-Steps--vSphere-"}}}